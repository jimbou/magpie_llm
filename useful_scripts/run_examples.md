# Run_examples.py script documentation

This documentation provides an overview and detailed usage guide for the Run_examples.py Python script designed to use the Magpie genetic programming tool for optimizing software based on various performance metrics. The script modifies a source file by adjusting the `retries` parameter, runs performance evaluations, applies patches generated by Magpie, and logs the results.

## Overview

The script performs the following actions:

1. **Modify Retry Value**: Dynamically changes the retry count in Magpie configuration files to run multiple optimization scenarios.
2. **Compile and Measure Performance**: Compiles and measures the performance of a source file, logging the median execution time before any modifications.
3. **Run Magpie Optimization**: Runs Magpie with different performance items and retry values, applies the generated patches, and measures the new performance.
4. **Log Results**: Outputs the results of each run, including execution times and patch details, to a JSON file.

## Dependencies

- Python 3.11
- External libraries: `subprocess`, `os`, `shutil`, `statistics`, `sys`, `time`, `json`, `re`
- Magpie (local installation or accessible via the system path)

## Functions

### `update_retries(filepath, new_retry_value)`

- **Purpose**: Updates the `retries =` line in a Magpie configuration file with a new retry value.
- **Parameters**:
  - `filepath`: Path to the Magpie configuration file.
  - `new_retry_value`: Integer representing the new retry value.
- **Returns**: The path to the newly created file with updated retries.

### `extract_data_from_log(file_path)`

- **Purpose**: Extracts retries, patch numbers, and fitness values from Magpie's log file.
- **Parameters**:
  - `file_path`: Path to the log file.
- **Returns**: A tuple containing retries number, maximum patch number, best fitness, and reference fitness.

### `run_command(command, directory=None)`

- **Purpose**: Executes a shell command in an optional directory context and captures its output.
- **Parameters**:
  - `command`: The command to execute.
  - `directory`: Directory in which to execute the command (default is current directory).
- **Returns**: The result object from `subprocess.run`.

### `create_directory_with_suffix(base_path)`

- **Purpose**: Creates a new directory based on a base path, appending a numeric suffix if the base directory already exists.
- **Parameters**:
  - `base_path`: The base path for the directory.
- **Returns**: The path to the newly created directory.

### `main(name1, name2, name3, compile_command, improved_file)`

- **Purpose**: Orchestrates the compilation, optimization, and evaluation of the software project.
- **Parameters**:
  - `name1`: Directory name of the example.
  - `name2`: Base name for the scenario.
  - `name3`: Name of the executable.
  - `compile_command`: Command to compile the project.
  - `improved_file`: Path to the source file that will be improved.

  # Detailed Guide to `main` Function in Python Script

This guide provides a detailed explanation of the `main` function in the script, which automates the optimization of software using Magpie based on various performance metrics.

## Functionality Overview

The `main` function performs several key operations:

1. **Initial Setup**: Sets up performance items and prepares for execution.
2. **Baseline Performance Measurement**: Compiles and measures the performance of the original code.
3. **Optimization Loop**: Iterates through performance metrics and retry counts, running Magpie optimizations.
4. **Apply Patches and Re-evaluate**: Applies Magpie-generated patches and re-measures performance.
5. **Data Logging**: Logs detailed performance data to a JSON file.

## Step-by-Step Breakdown

### Step 1: Initial Setup

- **Performance Items**: Defines a list of performance metrics to be optimized. Currently configured for 'time' and 'perf_time'.
- **Execution Times List**: Initializes an empty list to store execution times for later analysis.

### Step 2: Baseline Performance Measurement

- **Compile Command Execution**: Runs the provided compile command to ensure the software is built before performance testing.
- **Initial Performance Test**: Executes the original unmodified code 10 times to determine its median execution time, which is stored for comparison against optimized versions.

### Step 3: Optimization Loop

- **Directory Preparation**: Creates a new directory for storing optimization results and intermediate files.
- **Optimization Execution**:
  - For each item in the performance list and for each retry value from 1 to 5:
    - Updates the Magpie scenario configuration file to reflect the current retry count.
    - Runs Magpie to perform genetic optimization, measuring the duration of this process.
    - Cleans up by removing the temporary scenario configuration file.

### Step 4: Apply Patches and Re-evaluate

- **Patch Application**:
  - Retrieves paths to log, patch, and diff files from Magpie's output.
  - Copies necessary files to a structured directory layout for easy access and review.
  - Applies the patch to the source file and recompiles the software.
- **Re-evaluation**:
  - Executes the patched software 10 times to obtain new performance metrics (execution times), calculating the median value.

### Step 5: Data Logging

- **JSON Data Compilation**:
  - Constructs a detailed JSON object containing all relevant data from the optimization runs, including original and improved median execution times, the content of applied patches, and Magpie-specific metrics such as retries and fitness values.
- **File Output**:
  - Writes the compiled data to a JSON file within the main directory, ensuring all results from the current session are preserved.



## Usage

To use this script, navigate to the script's directory and run:

```bash
python3.11 run_examples.py <dir_name> <scenario_name> <executable_name> "compile_command" <source_file>
